<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer</title>
</head>
<body>

<h1>Streamer Dashboard</h1>
<p id="status">Connecting to server...</p>
<button id="create-room-btn">Create Room</button>

<h2>Room ID: <span id="room-id">N/A</span></h2>
<video id="stream-video" autoplay muted></video>

<script>
    const socket = new WebSocket('wss://final-5sjc.onrender.com');
    const statusElement = document.getElementById('status');
    const createRoomButton = document.getElementById('create-room-btn');
    const roomIdElement = document.getElementById('room-id');
    const streamVideo = document.getElementById('stream-video');

    let roomId = null;
    let peerConnection;
    const configuration = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'turn:your-turn-server.com', username: 'user', credential: 'pass' }
        ]
    };

    socket.onopen = () => {
        statusElement.textContent = 'Connected to server!';
    };

    socket.onmessage = (message) => {
        const data = JSON.parse(message.data);

        if (data.type === 'room-created') {
            roomId = data.roomId;
            roomIdElement.textContent = roomId;
            statusElement.textContent = `Room created with ID: ${roomId}`;
            startStreaming();
        }

        if (data.type === 'answer') {
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer)).catch(console.error);
        }

        if (data.type === 'candidate') {
            peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate)).catch(console.error);
        }
    };

    createRoomButton.onclick = () => {
        const createRoomMessage = JSON.stringify({ type: 'create-room' });
        socket.send(createRoomMessage);
    };

    async function startStreaming() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        streamVideo.srcObject = stream;

        peerConnection = new RTCPeerConnection(configuration);
        stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        socket.send(JSON.stringify({
            type: 'offer',
            roomId: roomId,
            offer: peerConnection.localDescription
        }));

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.send(JSON.stringify({
                    type: 'candidate',
                    roomId: roomId,
                    candidate: event.candidate
                }));
            }
        };
    }
</script>

</body>
</html>
