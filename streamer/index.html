<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer</title>
</head>
<body>

<h1>Streamer Dashboard</h1>
<p id="status">Connecting to server...</p>
<button id="create-room-btn">Create Room</button>

<h2>Room ID: <span id="room-id">N/A</span></h2>

<video id="stream-video" autoplay></video>

<script>
    const socket = new WebSocket('ws://localhost:3000');
    const statusElement = document.getElementById('status');
    const createRoomButton = document.getElementById('create-room-btn');
    const roomIdElement = document.getElementById('room-id');
    const streamVideo = document.getElementById('stream-video');

    let roomId = null;
    let peerConnection;
    const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // Handle connection
    socket.onopen = () => {
        statusElement.textContent = 'Connected to server!';
    };

    // Handle incoming messages
    socket.onmessage = (message) => {
        const data = JSON.parse(message.data);

        if (data.type === 'room-created') {
            roomId = data.roomId;
            roomIdElement.textContent = roomId;
            statusElement.textContent = `Room created with ID: ${roomId}`;

            // Access media devices and start streaming
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then((stream) => {
                    streamVideo.srcObject = stream;
                    startStreaming(stream);
                })
                .catch((err) => {
                    console.error('Error accessing media devices:', err);
                });
        }

        if (data.type === 'offer') {
            peerConnection = new RTCPeerConnection(configuration);

            // Add remote media stream to peer connection
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));

            // Add stream to peer connection
            const stream = streamVideo.srcObject;
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            // Create and send an answer
            peerConnection.createAnswer()
                .then((answer) => {
                    return peerConnection.setLocalDescription(answer);
                })
                .then(() => {
                    socket.send(JSON.stringify({
                        type: 'answer',
                        roomId: roomId,
                        answer: peerConnection.localDescription
                    }));
                });

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({
                        type: 'candidate',
                        roomId: roomId,
                        candidate: event.candidate
                    }));
                }
            };

            // Handle incoming stream from the streamer
            peerConnection.ontrack = (event) => {
                const remoteStream = event.streams[0];
                const viewerVideo = document.getElementById('viewer-video');
                viewerVideo.srcObject = remoteStream;
            };
        }

        if (data.type === 'candidate') {
            peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    };

    // Handle creating a room
    createRoomButton.onclick = () => {
        const createRoomMessage = JSON.stringify({ type: 'create-room' });
        socket.send(createRoomMessage);
    };

    // Start streaming function
    function startStreaming(stream) {
        peerConnection = new RTCPeerConnection(configuration);
        stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

        // Create offer and send it to viewers
        peerConnection.createOffer()
            .then((offer) => {
                return peerConnection.setLocalDescription(offer);
            })
            .then(() => {
                socket.send(JSON.stringify({
                    type: 'offer',
                    roomId: roomId,
                    offer: peerConnection.localDescription
                }));
            });

        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                socket.send(JSON.stringify({
                    type: 'candidate',
                    roomId: roomId,
                    candidate: event.candidate
                }));
            }
        };
    }
</script>

</body>
</html>
