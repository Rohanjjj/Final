<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Streamer</title>
  <style>
    #stream {
      width: 100%;
      max-width: 800px;
      height: auto;
      border: 2px solid black;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Streamer: Screen Sharing</h1>
  <label for="roomId">Enter Room ID to Stream:</label>
  <input type="text" id="roomId" placeholder="Room ID">
  <button onclick="startStreaming()">Start Streaming</button>
  
  <video id="stream" autoplay muted></video>

  <script>
    let ws;
    let peerConnection;

    // Function to start streaming
    function startStreaming() {
      const roomId = document.getElementById('roomId').value.trim();
      if (!roomId) {
        alert('Please enter a room ID.');
        return;
      }

      // Create WebSocket connection
      ws = new WebSocket('wss://final-5sjc.onrender.com');
      ws.onopen = () => {
        console.log('Connected to WebSocket server');

        // Send stream details and room ID
        ws.send(JSON.stringify({
          type: 'streamer',
          roomId: roomId
        }));

        // Get user media for screen sharing (both video and audio)
        navigator.mediaDevices.getDisplayMedia({ video: true, audio: true })
          .then((stream) => {
            const videoElement = document.getElementById('stream');
            videoElement.srcObject = stream;

            // Initialize WebRTC peer connection
            peerConnection = new RTCPeerConnection();

            // Add stream tracks to peer connection
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
              if (event.candidate) {
                ws.send(JSON.stringify({
                  type: 'candidate',
                  roomId: roomId,
                  candidate: event.candidate
                }));
              }
            };

            // Create an offer
            peerConnection.createOffer()
              .then(offer => peerConnection.setLocalDescription(offer))
              .then(() => {
                ws.send(JSON.stringify({
                  type: 'offer',
                  roomId: roomId,
                  sdp: peerConnection.localDescription
                }));
              });
          })
          .catch((err) => {
            console.error('Error accessing screen share:', err);
          });
      };

      ws.onmessage = (event) => {
        const message = JSON.parse(event.data);
        if (message.type === 'answer') {
          peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
        } else if (message.type === 'candidate') {
          peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
        }
      };
    }
  </script>
</body>
</html>
