<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer</title>
</head>
<body>

<h1>Viewer Page</h1>
<video id="viewer-video" autoplay></video>
<input type="text" id="room-id-input" placeholder="Enter Room ID" />
<button id="join-room-btn">Join Room</button>

<script>
    const socket = new WebSocket('ws://final-5sjc.onrender.com');
    const roomIdInput = document.getElementById('room-id-input');
    const joinRoomButton = document.getElementById('join-room-btn');
    const viewerVideo = document.getElementById('viewer-video');
    let peerConnection;
    const roomId = null;
    const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // Handle connection
    socket.onopen = () => {
        console.log('Connected to server');
    };

    socket.onmessage = (message) => {
        const data = JSON.parse(message.data);

        if (data.type === 'room-joined' && data.success) {
            roomId = data.roomId;
            console.log(`Joined room: ${roomId}`);
        }

        if (data.type === 'offer') {
            peerConnection = new RTCPeerConnection(configuration);

            // Set remote offer
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));

            // Create an answer and send it back to the streamer
            peerConnection.createAnswer()
                .then((answer) => {
                    return peerConnection.setLocalDescription(answer);
                })
                .then(() => {
                    socket.send(JSON.stringify({
                        type: 'answer',
                        roomId: roomId,
                        answer: peerConnection.localDescription
                    }));
                });

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({
                        type: 'candidate',
                        roomId: roomId,
                        candidate: event.candidate
                    }));
                }
            };

            // Add remote media stream
            peerConnection.ontrack = (event) => {
                const remoteStream = event.streams[0];
                viewerVideo.srcObject = remoteStream;
            };
        }

        if (data.type === 'candidate') {
            peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
    };

    // Join room
    joinRoomButton.onclick = () => {
        const roomId = roomIdInput.value.trim();
        if (roomId) {
            const joinRoomMessage = JSON.stringify({
                type: 'join-room',
                roomId: roomId
            });
            socket.send(joinRoomMessage);
        }
    };
</script>

</body>
</html>
