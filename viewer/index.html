<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viewer</title>
  <style>
    #video {
      width: 100%;
      max-width: 800px;
      height: auto;
      border: 2px solid black;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Viewer: Watching Stream</h1>
  <label for="roomId">Enter Room ID to Watch:</label>
  <input type="text" id="roomId" placeholder="Room ID">
  <button onclick="joinStream()">Join Stream</button>
  
  <video id="video" autoplay controls></video>

  <script>
    let ws;
    let peerConnection;

    // Function to join stream
    function joinStream() {
      const roomId = document.getElementById('roomId').value.trim();
      if (!roomId) {
        alert('Please enter a room ID.');
        return;
      }

      // Create WebSocket connection
      ws = new WebSocket('wss://final-5sjc.onrender.com');
      ws.onopen = () => {
        console.log('Connected to WebSocket server');

        // Send viewer details and room ID
        ws.send(JSON.stringify({
          type: 'viewer',
          roomId: roomId
        }));
      };

      ws.onmessage = (event) => {
        const message = JSON.parse(event.data);

        if (message.type === 'start-stream') {
          peerConnection = new RTCPeerConnection();

          // Handle ICE candidates
          peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
              ws.send(JSON.stringify({
                type: 'candidate',
                roomId: roomId,
                candidate: event.candidate
              }));
            }
          };

          // Handle incoming stream
          peerConnection.ontrack = (event) => {
            const videoElement = document.getElementById('video');
            videoElement.srcObject = event.streams[0];
          };

          // Respond to the streamer's offer
          if (message.sdp) {
            peerConnection.setRemoteDescription(new RTCSessionDescription(message.sdp));
            peerConnection.createAnswer()
              .then(answer => peerConnection.setLocalDescription(answer))
              .then(() => {
                ws.send(JSON.stringify({
                  type: 'answer',
                  roomId: roomId,
                  sdp: peerConnection.localDescription
                }));
              });
          }
        } else if (message.type === 'candidate') {
          peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
        }
      };
    }
  </script>
</body>
</html>
