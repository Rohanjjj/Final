<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viewer Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #viewer-video {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>

<h1>Viewer Dashboard</h1>
<p id="status">Connecting to server...</p>
<input type="text" id="room-id-input" placeholder="Enter Room ID" />
<button id="join-room-btn">Join Room</button>

<h2>Room ID: <span id="current-room-id">N/A</span></h2>

<h3>Stream Data:</h3>
<video id="viewer-video" autoplay></video>

<h3>Send a Comment:</h3>
<input type="text" id="comment-input" placeholder="Enter comment" />
<button id="send-comment-btn">Send Comment</button>

<script>
    const socket = new WebSocket('wss://final-5sjc.onrender.com');
    const statusElement = document.getElementById('status');
    const roomIdInput = document.getElementById('room-id-input');
    const joinRoomButton = document.getElementById('join-room-btn');
    const currentRoomIdElement = document.getElementById('current-room-id');
    const viewerVideoElement = document.getElementById('viewer-video');
    const commentInput = document.getElementById('comment-input');
    const sendCommentButton = document.getElementById('send-comment-btn');

    let roomId = null;
    let peerConnection;

    // Handle connection
    socket.onopen = () => {
        statusElement.textContent = 'Connected to server!';
    };

    // Handle incoming messages
    socket.onmessage = (message) => {
        const data = JSON.parse(message.data);
        console.log("Received message from server:", data);

        // Handle room joining response
        if (data.type === 'room-joined' && data.success) {
            roomId = data.roomId;
            currentRoomIdElement.textContent = roomId;
            statusElement.textContent = `Joined room: ${roomId}`;

            // Initialize WebRTC peer connection
            peerConnection = new RTCPeerConnection();

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({
                        type: 'candidate',
                        roomId: roomId,
                        candidate: event.candidate
                    }));
                }
            };

            // Handle incoming tracks (video/audio streams)
            peerConnection.ontrack = (event) => {
                const remoteStream = event.streams[0];
                console.log('Received remote stream');
                viewerVideoElement.srcObject = remoteStream;
            };
        }

        // Handle offer from the streamer
        if (data.type === 'offer' && data.roomId === roomId) {
            console.log('Received offer from streamer');
            peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer))
                .then(() => peerConnection.createAnswer())
                .then(answer => peerConnection.setLocalDescription(answer))
                .then(() => {
                    socket.send(JSON.stringify({
                        type: 'answer',
                        roomId: roomId,
                        answer: peerConnection.localDescription
                    }));
                })
                .catch(err => console.error('Error handling offer:', err));
        }

        // Handle ICE candidate from the streamer
        if (data.type === 'candidate' && data.roomId === roomId) {
            console.log('Received ICE candidate');
            peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate))
                .catch(err => console.error('Error adding ICE candidate:', err));
        }

        // Handle stream data and comments
        if (data.type === 'stream-data') {
            console.log('Stream Data:', data.data);
        }

        if (data.type === 'comment') {
            console.log('New Comment:', data.message);
        }
    };

    socket.onerror = (error) => {
        console.error('WebSocket Error:', error);
        statusElement.textContent = 'Error connecting to the server';
    };

    socket.onclose = () => {
        statusElement.textContent = 'Connection closed';
    };

    // Handle joining a room
    joinRoomButton.onclick = () => {
        const roomIdInputValue = roomIdInput.value.trim();
        if (roomIdInputValue) {
            const joinRoomMessage = JSON.stringify({
                type: 'join-room',
                roomId: roomIdInputValue
            });
            socket.send(joinRoomMessage);
        } else {
            statusElement.textContent = 'Please enter a room ID.';
        }
    };

    // Handle sending comments
    sendCommentButton.onclick = () => {
        const comment = commentInput.value.trim();
        if (comment && roomId) {
            const commentMessage = {
                type: 'comment',
                roomId: roomId,
                data: { message: comment }
            };
            socket.send(JSON.stringify(commentMessage));
            commentInput.value = ''; // Clear input after sending
        }
    };
</script>

</body>
</html>
